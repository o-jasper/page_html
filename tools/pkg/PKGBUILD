# Maintainer: Jasper den Ouden <o.jasper@gmail.com>
#
# Note: package is mean, installs itself in /usr/share/
# I didn't feel like figuring out where the packages go, its all just in there.
#  also why not in AUR.
# Another reason is that i don't actually want to make the lua accessible as
# lib, as i

pkgname=page_html_set.lua
pkgver=0.0
pkgrel=0
pkgdesc="Userscript and lua server for bookmarks, history and a bunch of commands.(like watch-with-mpv)"
arch=('i686' 'x86_64')
url="https://github.com/o-jasper/page_html"
license=('AGPL, MIT')
# Note: more dependencies are already-packaged-in. (pegasus, bunch of stuff of mine)
depends=('lua' 'lua-socket' 'lua-sql-sqlite')

makedepends=()
optdepends=('mpv: directly view videos with mpv'
            'wget: for downloading things')
options=(!emptydirs)
# Note:  no security here, make sure the md5sums/sha256sums are proper.
source=("http://ojasper.nl/data/${pkgname}.${pkgver}.tar.bz2")

# Note this is as-of the-commit-after-b9da82a82e975f1462921dad4501e5ca751fcedf
sha256sums=('9ee6ab7aa4acedf31b5e9fa4deb28a0956610b64c273661d94e1069180118ce0')
md5sums=('080adbc53e0e6c667aaccda54612b353')

build() {
  # Add "binary" that selects the proper lua packages.
  mkdir -p bin/
  echo '#!/usr/bin/lua' > bin/page_html_set.lua
  echo 'package.path="/usr/share/local/'${pkgname}'/page_html/?.lua;/usr/share/local/'${pkgname}'/page_html/?/init.lua"' >> bin/page_html_set.lua
  echo '-- package.cpath should be fine' >> bin/page_html_set.lua
  echo >> bin/page_html_set.lua
  cat ${pkgname}/page_html/run.lua >> bin/page_html_set.lua
}

package() {
  # The "executable"
  install -D -m755 bin/page_html_set.lua ${pkgdir}/usr/bin/page_html_set.lua
  # Rest of the files. This PKGBUILD is a bit of a "dump it in"
  mkdir -p ${pkgdir}/usr/share/local/${pkgname}/
  find ${pkgname}/ -type f | while read line; do
    install -D -m644 $line ${pkgdir}/usr/share/local/$line
  done
}
